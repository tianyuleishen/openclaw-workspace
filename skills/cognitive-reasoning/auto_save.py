#!/usr/bin/env python3
"""
Auto Memory Saver - Full Auto Mode
å…¨ä¸»åŠ¨è®°å¿†ä¿å­˜ï¼šæ¯æ¬¡å†³ç­–åè‡ªåŠ¨ä¿å­˜åˆ°è®°å¿†ç³»ç»Ÿ
"""

import sys
import json
from datetime import datetime
from pathlib import Path
import os

class AutoMemorySaver:
    """
    è‡ªåŠ¨è®°å¿†ä¿å­˜å™¨
    åŠŸèƒ½ï¼š
    - æ¯æ¬¡å†³ç­–åè‡ªåŠ¨ä¿å­˜
    - æ™ºèƒ½è¯†åˆ«é‡è¦äº‹ä»¶
    - è‡ªåŠ¨æ›´æ–° MEMORY.md å’Œ daily notes
    """
    
    def __init__(self):
        self.workspace = Path.home() / ".openclaw/workspace"
        self.memory_file = self.workspace / "MEMORY.md"
        self.daily_file = self.workspace / "memory" / f"{datetime.now().strftime('%Y-%m-%d')}.md"
        self.history_file = self.workspace / ".memory_history.json"
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        (self.workspace / "memory").mkdir(exist_ok=True)
    
    def save_decision(self, decision_type, content, confidence=None, context=None):
        """
        ä¿å­˜å†³ç­–
        å‚æ•°:
            decision_type: å†³ç­–ç±»å‹ (LEARNING/CONFIG/DECISION/EVENT)
            content: å†³ç­–å†…å®¹
            confidence: ç½®ä¿¡åº¦ (å¯é€‰)
            context: ä¸Šä¸‹æ–‡ä¿¡æ¯ (å¯é€‰)
        """
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M")
        
        entry = {
            "timestamp": timestamp,
            "type": decision_type,
            "content": content,
            "confidence": confidence,
            "context": context
        }
        
        # ä¿å­˜åˆ°daily notes
        self._save_to_daily(entry)
        
        # æ›´æ–°é•¿æœŸè®°å¿†
        self._update_memory(entry)
        
        # ä¿å­˜åˆ°å†å²è®°å½•
        self._save_history(entry)
        
        return entry
    
    def _save_to_daily(self, entry):
        """ä¿å­˜åˆ°æ¯æ—¥ç¬”è®°"""
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M")
        
        content = f"""
### {entry['type']} - {timestamp}

**{entry['content']}**

"""
        if entry['confidence']:
            content += f"- ç½®ä¿¡åº¦: {entry['confidence']*100:.0f}%\n"
        
        if entry['context']:
            content += f"- ä¸Šä¸‹æ–‡: {entry['context']}\n"
        
        with open(self.daily_file, 'a', encoding='utf-8') as f:
            f.write(content)
    
    def _update_memory(self, entry):
        """æ›´æ–°é•¿æœŸè®°å¿†"""
        if not self.memory_file.exists():
            self._init_memory_file()
        
        # è¯»å–ç°æœ‰å†…å®¹
        with open(self.memory_file, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # æ·»åŠ æ–°æ¡ç›®
        new_section = f"""
## {entry['timestamp']} - {entry['type']}

**{entry['content']}**

"""
        if entry['confidence']:
            new_section += f"- ç½®ä¿¡åº¦: {entry['confidence']*100:.0f}%\n"
        
        if entry['context']:
            new_section += f"- ä¸Šä¸‹æ–‡: {entry['context']}\n"
        
        # åœ¨ç¬¬ä¸€ä¸ªæ ‡é¢˜å‰æ’å…¥ï¼Œæˆ–è¿½åŠ åˆ°æœ«å°¾
        if "## " in content:
            first_header = content.find("## ")
            new_content = content[:first_header] + new_section + "\n" + content[first_header:]
        else:
            new_content = content + new_section
        
        with open(self.memory_file, 'w', encoding='utf-8') as f:
            f.write(new_content)
    
    def _save_history(self, entry):
        """ä¿å­˜åˆ°å†å²è®°å½•"""
        history = []
        if self.history_file.exists():
            with open(self.history_file, 'r') as f:
                history = json.load(f)
        
        history.append(entry)
        
        # åªä¿ç•™æœ€è¿‘100æ¡
        history = history[-100:]
        
        with open(self.history_file, 'w') as f:
            json.dump(history, f, ensure_ascii=False, indent=2)
    
    def _init_memory_file(self):
        """åˆå§‹åŒ–MEMORY.md"""
        with open(self.memory_file, 'w', encoding='utf-8') as f:
            f.write("""# MEMORY.md - Your Long-Term Memory

*Auto-generated by Auto Memory Saver*

---

## How to Use

This file stores your permanent memories:
- Important decisions
- Learned patterns
- Configuration changes
- Key events

---

""")
    
    def auto_save_from_cognition(self, result):
        """ä»è®¤çŸ¥æ¡†æ¶ç»“æœè‡ªåŠ¨ä¿å­˜"""
        if result['confidence'] >= 0.80:
            self.save_decision(
                decision_type="DECISION",
                content=f"æ‰§è¡Œä»»åŠ¡: {result['intent']['type']}",
                confidence=result['confidence'],
                context=f"ç½®ä¿¡åº¦ {result['confidence']*100:.0f}%"
            )
            return True
        return False
    
    def save_learning(self, topic, insight):
        """ä¿å­˜å­¦ä¹ """
        self.save_decision(
            decision_type="LEARNING",
            content=f"å­¦ä¹ : {topic}",
            context=insight
        )
    
    def save_config(self, config_name, old_value, new_value):
        """ä¿å­˜é…ç½®å˜æ›´"""
        self.save_decision(
            decision_type="CONFIG",
            content=f"é…ç½®å˜æ›´: {config_name}",
            context=f"{old_value} â†’ {new_value}"
        )


def main():
    """æµ‹è¯•"""
    saver = AutoMemorySaver()
    
    print("ğŸ§  è‡ªåŠ¨è®°å¿†ä¿å­˜å™¨æµ‹è¯•")
    print("=" * 50)
    
    # æµ‹è¯•ä¿å­˜å†³ç­–
    entry = saver.save_decision(
        decision_type="TEST",
        content="æµ‹è¯•è‡ªåŠ¨ä¿å­˜åŠŸèƒ½",
        confidence=0.95,
        context="æµ‹è¯•ç¯å¢ƒ"
    )
    
    print(f"\nâœ… å·²ä¿å­˜:")
    print(f"   ç±»å‹: {entry['type']}")
    print(f"   æ—¶é—´: {entry['timestamp']}")
    print(f"   å†…å®¹: {entry['content']}")
    print(f"   ç½®ä¿¡åº¦: {entry['confidence']*100:.0f}%")
    
    print(f"\nğŸ“ ä¿å­˜ä½ç½®:")
    print(f"   æ¯æ—¥ç¬”è®°: {saver.daily_file}")
    print(f"   é•¿æœŸè®°å¿†: {saver.memory_file}")


if __name__ == "__main__":
    main()
